# SAFETY TIMEOUT WATCHDOG - SYSTEM ARCHITECTURE & FLOWS

## ğŸ—ï¸ SYSTEM ARCHITECTURE DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SAFETY TIMEOUT SYSTEM                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ESP32        â”‚                                  â”‚ WEB DASHBOARD    â”‚
â”‚   Robot Brain    â”‚                                  â”‚ (Chrome/Safari)  â”‚
â”‚                  â”‚                                  â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                                  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Loop()     â”‚ â”‚                                  â”‚ â”‚  init()      â”‚ â”‚
â”‚ â”‚  every 100ms â”‚ â”‚                                  â”‚ â”‚ on page load â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                                  â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚         â”‚                                  â”‚    â”‚             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Check Timer  â”‚ â”‚     â”‚   FIREBASE REALTIME  â”‚    â”‚ â”‚   Listen    â”‚ â”‚
â”‚ â”‚ (2.5s?)      â”‚ â”‚     â”‚    DATABASE          â”‚    â”‚ â”‚ lastHB time â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     â”‚                      â”‚    â”‚ â”‚ (real-time) â”‚ â”‚
â”‚        â”‚ YES     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚          â–²          â–¼           â”‚    â”‚             â”‚
â”‚ â”‚   Write      â”‚â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ WRITE   READâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â–ºâ”‚  Compare    â”‚
â”‚ â”‚ timestamp()  â”‚ â”‚          â”‚  LISTEN     â”‚        â”‚    â”‚  time diff  â”‚
â”‚ â”‚ to firebase  â”‚ â”‚          â–¼            â–²        â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚     /robot/           â”‚        â”‚    â”‚             â”‚
â”‚                  â”‚     lastHeartbeat      â”‚        â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                  â”‚                        â”‚        â”‚ â”‚ Check state â”‚ â”‚
â”‚ Send every 2.5s  â”‚     Timestamp:         â”‚        â”‚ â”‚ GREEN/      â”‚ â”‚
â”‚                  â”‚     1704067245000      â”‚        â”‚ â”‚ ORANGE/RED  â”‚ â”‚
â”‚                  â”‚                        â”‚        â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚     /robot/emergency/  â”‚        â”‚    â”‚             â”‚
â”‚                  â”‚     active: boolean    â”‚        â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                  â”‚                        â”‚        â”‚ â”‚  Update UI  â”‚ â”‚
â”‚                  â”‚     Listen for         â”‚        â”‚ â”‚  Countdown  â”‚ â”‚
â”‚                  â”‚     emergency flag     â”‚        â”‚ â”‚  Warning    â”‚ â”‚
â”‚                  â”‚                        â”‚        â”‚ â”‚  Buttons    â”‚ â”‚
â”‚                  â”‚                        â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚                        â”‚        â”‚                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                        â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚  Check for   â”‚ â”‚                        â”‚        â”‚ â”‚ If >5 sec?  â”‚ â”‚
â”‚ â”‚  Emergency   â”‚ â”‚                        â”‚        â”‚ â”‚ WRITE true  â”‚ â”‚
â”‚ â”‚  flag = true?â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚ to active   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚        â”‚         â”‚                        â”‚        â”‚                  â”‚
â”‚        â”‚ YES     â”‚                        â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”‚                        â”‚        â”‚ â”‚  Show RED   â”‚ â”‚
â”‚ â”‚   STOP ALL   â”‚ â”‚                        â”‚        â”‚ â”‚  BANNER &   â”‚ â”‚
â”‚ â”‚   MOTORS     â”‚ â”‚                        â”‚        â”‚ â”‚  Disable    â”‚ â”‚
â”‚ â”‚   STOP BLADE â”‚ â”‚                        â”‚        â”‚ â”‚  buttons    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                        â”‚        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                  â”‚                        â”‚        â”‚                  â”‚
â”‚ Fail-safe:  NO   â”‚                        â”‚        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ heartbeat = STOP â”‚                        â”‚        â”‚ â”‚  Wait for    â”‚ â”‚
â”‚                  â”‚                        â”‚        â”‚ â”‚  Restart btn â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚        â”‚ â”‚  Click       â”‚ â”‚
                                            â”‚        â”‚ â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                            â”‚        â”‚    â”‚             â”‚
                                            â”‚        â”‚    â”‚ User clicks â”‚
                                            â”‚        â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                            â”‚        â”‚ â”‚ WRITE false â”‚ â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”€â–º â”‚ to active   â”‚ â”‚
                                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                     â”‚                  â”‚
                                                     â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
                                                     â”‚ â”‚ Enable btns  â”‚ â”‚
                                                     â”‚ â”‚ Hide banner  â”‚ â”‚
                                                     â”‚ â”‚ Ready!       â”‚ â”‚
                                                     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ NORMAL OPERATION FLOW

```
     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘           NORMAL OPERATION (Heartbeat < 4 sec)             â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ESP32 Timeline                  Firebase              Web Dashboard
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[T=0s] Write beat
  â”‚                              âœ“ lastHeartbeat: 
  â”‚                                1704067245000
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Listener fires
  â”‚                                          â”‚
  â”‚                          [200ms loop]    â”‚
  â”‚                          Calc diff:      â”‚ T=0s â”€ T=0s = 0ms
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Color: GREEN âœ“
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Countdown: 5.0s
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Message: "âœ“ Connected"
  â”‚                                          â”‚
  â”‚                                          â””â”€ Controls: ENABLED
                                            
[T=2.5s] Write beat
  â”‚                              âœ“ lastHeartbeat:
  â”‚                                1704067247500
  â”‚                                          â”‚
  â”‚                          [200ms loop]    â”‚
  â”‚                          Calc diff:      â”‚ T=2.5s - T=2.5s = 0ms
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Color: GREEN âœ“
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Countdown: 5.0s
  â”‚                                          â”‚
  â”‚                                          â””â”€ All normal

[T=5s] Write beat
  â”‚                              âœ“ lastHeartbeat:
  â”‚                                1704067250000
  â”‚                                          â”‚
  â”‚                          [200ms loop]    â”‚
  â”‚                          Calc diff:      â”‚ T=5s - T=5s = 0ms
  â”‚                                          â”‚
  â”‚                                          â”œâ”€ Color: GREEN âœ“
  â”‚                                          â”‚
  â”‚                                          â””â”€ System healthy

     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘              RESULT: NO EMERGENCY TRIGGERED                â•‘
     â•‘           All controls enabled, system operating           â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## âš ï¸ WEAK SIGNAL FLOW (4-5 seconds)

```
     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘        DEGRADED CONNECTION (Heartbeat 4-5 sec old)         â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ESP32 Timeline                  Firebase              Web Dashboard
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[T=0s] Write beat
  â”‚                              âœ“ lastHeartbeat: 1704067245000

[T=2.5s] Write beat
  â”‚                              âœ“ lastHeartbeat: 1704067247500

WiFi weak... (no beat for 4sec)

                                âœ“ lastHeartbeat: 1704067247500
                                (STALE - 4 seconds old)
                                          â”‚
                                [200ms loop]
                                Calc diff:
                        (Now T=4s) - (Last beat T=2.5s) = 1.5s OLD
                                          â”‚
                                          â”œâ”€ Compare: 1500ms < 4000ms
                                          â”‚   (warningThreshold)
                                          â”‚
                                          â”œâ”€ But > 0ms, so...
                                          â”‚
                                          â”œâ”€ Color: GREEN âœ“ (still ok)
                                          â”‚
                                          â””â”€ Countdown: ~1.5s remaining

[T=4.1s] - NO NEW BEAT

                        (Now T=4.1s) - (Last beat T=2.5s) = 1.6s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                1600ms < 4000ms? YES
                                          â”‚
                                          â”œâ”€ Color: STILL GREEN
                                          â”‚
                                          â””â”€ Countdown: ~1.4s remaining

[T=4.2s] - Still no beat

                        (Now T=4.2s) - (Last beat T=2.5s) = 1.7s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                1700ms < 4000ms? YES
                                          â”‚
                                          â”œâ”€ Color: STILL GREEN
                                          â”‚
                                          â””â”€ Countdown: ~1.3s remaining

[T=4.3s] - CROSSING WARNING THRESHOLD âš ï¸

                        (Now T=4.3s) - (Last beat T=2.5s) = 1.8s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                1800ms > 4000ms? NO, still under...

[T=4.4s] - Getting close

                        (Now T=4.4s) - (Last beat T=2.5s) = 1.9s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                1900ms < 4000ms? YES but very close
                                          â”‚
                                          â”œâ”€ Color: STILL MOSTLY GREEN
                                          â”‚
                                          â””â”€ Countdown: ~1.1s

[T=4.5s] - HITS WARNING THRESHOLD ğŸŸ 

                        (Now T=4.5s) - (Last beat T=2.5s) = 2.0s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                2000ms > 4000ms? NO... wait...
                                
Actually, if NO beat since T=2.5s, and we're at T=4.5s:
                        (Now T=4.5s) - (Last beat T=2.5s) = 2.0s OLD

But if the LAST beat was at T=2.5s and we're checking at T=4.5s:
That's only 2 seconds elapsed... Let me recalculate:

If heartbeat interval is 2.5s and last beat was at T=2.5s,
next beat should arrive at T=5.0s.

At T=4.5s: (T=4.5s) - (Last T=2.5s) = 2.0s OLD
                        (That's < 4s, so still GREEN)

At T=5.5s: (T=5.5s) - (Last T=2.5s) = 3.0s OLD
                        (Still < 4s, so still GREEN)

At T=6.0s: (T=6.0s) - (Last T=2.5s) = 3.5s OLD
                        (Still < 4s, so still GREEN)

At T=6.5s: (T=6.5s) - (Last T=2.5s) = 4.0s OLD
                        (= 4s, so entering ORANGE warning)
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                4000ms >= 4000ms? YES âš ï¸
                                          â”‚
                                          â”œâ”€ Color: ORANGE ğŸŸ 
                                          â”‚
                                          â”œâ”€ Countdown: ~0.5s remaining
                                          â”‚
                                          â”œâ”€ Message: "âš ï¸ Weak Signal"
                                          â”‚
                                          â”œâ”€ Warning box appears
                                          â”‚
                                          â””â”€ Controls: STILL ENABLED
                                             (But user can see
                                              emergency is coming)

At T=7.0s: (T=7.0s) - (Last T=2.5s) = 4.5s OLD
                                          â”‚
                                [200ms loop]
                                Calc diff:
                                4500ms >= 4000ms and < 5000ms
                                          â”‚
                                          â”œâ”€ Color: ORANGE ğŸŸ 
                                          â”‚
                                          â”œâ”€ Countdown: ~0.0s
                                          â”‚
                                          â”œâ”€ Animation: Pulsing faster
                                          â”‚
                                          â””â”€ Message: "âš ï¸ Weak Signal"

     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘        RESULT: ORANGE WARNING, MANUAL INTERVENTION NEEDED   â•‘
     â•‘    User can see connection is degraded and take action     â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸš¨ EMERGENCY TRIGGER FLOW (>5 seconds)

```
     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘      CONNECTION LOST (Heartbeat > 5 sec, Emergency!)       â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

No heartbeat received during entire 2.5s window

ESP32 Timeline                  Firebase              Web Dashboard
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[T=0s] Last write: beat
                                âœ“ lastHeartbeat: 1704067240000

[T=2.5s] NO WRITE (WiFi gone)
                                âœ“ lastHeartbeat: 1704067240000
                                (STALE - stuck at old value)

[T=5.05s] WEB CHECKS

                        (Now T=5.05s) - (Last beat T=0s) = 5.05s OLD
                                          â”‚
                                [200ms loop EVERY 200ms]
                                Calc diff:
                                5050ms > 5000ms? YES! ğŸš¨
                                          â”‚
                          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
                          â•‘   EMERGENCY TRIGGERED!      â•‘
                          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          
                                          â”œâ”€ Color: RED ğŸ”´
                                          â”‚
                                          â”œâ”€ Console log:
                                          â”‚  "ğŸš¨ EMERGENCY TRIGGERED:
                                          â”‚   HEARTBEAT TIMEOUT"
                                          â”‚
                                          â”œâ”€ Write to Firebase:
                                          â”‚  /robot/emergency/active = true
                                          â”‚
                                          â”œâ”€ UI Updates:
                                          â”‚  - Countdown: 0.0s
                                          â”‚  - Animation: Rapid pulse
                                          â”‚  - Red banner appears
                                          â”‚  - Message:
                                          â”‚    "âš ï¸ CONNECTION LOST â€”
                                          â”‚     EMERGENCY STOP ACTIVATED"
                                          â”‚
                                          â”œâ”€ Disable ALL controls:
                                          â”‚  - btn-start: DISABLED
                                          â”‚  - btn-pause: DISABLED
                                          â”‚  - btn-home: DISABLED
                                          â”‚  - Movement buttons: DISABLED
                                          â”‚  - Mode buttons: DISABLED
                                          â”‚  (All opacity 0.4)
                                          â”‚
                                          â””â”€ Show Restart button:
                                             "Emergency Restart" appears
                                             but DISABLED (no heartbeat)

[T=5.25s] WEB CHECKS AGAIN

                        (Now T=5.25s) - (Last beat T=0s) = 5.25s OLD
                                          â”‚
                                5250ms > 5000ms? YES
                                          â”‚
                                          â”œâ”€ Still in emergency
                                          â”‚
                                          â”œâ”€ Countdown: Still 0.0s (RED)
                                          â”‚
                                          â””â”€ All controls: Still disabled

[No heartbeat arrives...] â† Robots WiFi/connection is broken

[T=5.45s] - Still no beat
[T=5.65s] - Still no beat
[T=6.0s] - Still no beat

                        (Now T=6.0s) - (Last beat T=0s) = 6.0s OLD
                                          â”‚
                                6000ms > 5000ms? YES âœ“
                                          â”‚
                                          â””â”€ Confirms: EMERGENCY ACTIVE
                                             Restart button NOT enabled
                                             (can't restart until beat returns)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

MEANWHILE ON ESP32: (What SHOULD happen)
- WiFi reconnects (after 10-30 seconds typically)
- Starts sending heartbeats again
- But WEB DASHBOARD is already in emergency mode

[T=40s] Heartbeat resumes!

                                âœ“ lastHeartbeat: 1704067280000
                                (NEW value, recent!)
                                          â”‚
                                [200ms loop]
                                Calc diff:
                        (Now T=40s) - (Last beat T=40s) = ~0s OLD
                                          â”‚
                                          â”œâ”€ Color: GREEN âœ“
                                          â”‚
                                          â”œâ”€ Console log:
                                          â”‚  "ğŸ’“ Heartbeat received"
                                          â”‚
                                          â”œâ”€ Countdown: 5.0s
                                          â”‚
                                          â”œâ”€ Message: "âœ“ Connected" 
                                          â”‚
                                          â”œâ”€ Controls: Still DISABLED
                                          â”‚  (emergency was triggered)
                                          â”‚
                                          â””â”€ Restart button: CHANGED!
                                             Now ENABLED (clickable)
                                             "Emergency Restart" is ready

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

USER SEES:
1. RED emergency banner with countdown at 0.0s (6-40 seconds)
2. All buttons grayed out
3. "Emergency Restart" button appears (but disabled at first)
4. After heartbeat returns, "Emergency Restart" becomes clickable

USER ACTION: Click "Emergency Restart"
                                          â”‚
                                Restart function:
                                â”œâ”€ Write to Firebase:
                                â”‚  /robot/emergency/active = false
                                â”‚
                                â”œâ”€ Console log:
                                â”‚  "ğŸ”„ EMERGENCY RESTART INITIATED"
                                â”‚  "âœ“ Emergency flag cleared"
                                â”‚  "âœ“ Controls re-enabled"
                                â”‚
                                â”œâ”€ UI Updates (500ms):
                                â”‚  - Red banner: HIDDEN
                                â”‚  - All buttons: RE-ENABLED
                                â”‚  - Restart button: HIDDEN
                                â”‚  - Color: Back to GREEN
                                â”‚
                                â””â”€ System: Ready to resume operation

     â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
     â•‘         RESULT: EMERGENCY STOP ACTIVATED                   â•‘
     â•‘    Motor is stopped until user manually restarts system    â•‘
     â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## ğŸ“Š STATE MACHINE DIAGRAM

```
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚   SYSTEM INITIALIZATION  â”‚
                  â”‚   (On page load)         â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  LISTENING FOR HEARTBEAT â”‚
                  â”‚  (Firebase listener OK)  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                     â”‚
                    â–¼                     â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   GREEN STATE        â”‚  â”‚ HEARTBEAT TIMEOUT  â”‚
      â”‚   âœ“ Connected        â”‚  â”‚ (No beat > 5 sec)  â”‚
      â”‚                      â”‚  â”‚                    â”‚
      â”‚ â€¢ Countdown: 5.0s    â”‚  â”‚ TRIGGER ACTION:    â”‚
      â”‚ â€¢ Color: GREEN       â”‚  â”‚ â”œâ”€ Write          â”‚
      â”‚ â€¢ Controls: ENABLED  â”‚  â”‚ â”‚ emergency=true   â”‚
      â”‚ â€¢ Message: âœ“         â”‚  â”‚ â”œâ”€ Show RED banner â”‚
      â”‚                      â”‚  â”‚ â”œâ”€ Disable buttons â”‚
      â”‚ Transition: Beat     â”‚  â”‚ â””â”€ Show restart btnâ”‚
      â”‚ arrives every 2.5s   â”‚  â”‚                    â”‚
      â”‚ OR > 4s stale        â”‚  â”‚ Transition: Wait   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ for heartbeat +    â”‚
                 â”‚              â”‚ user restart       â”‚
                 â”‚              â”‚                    â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ORANGE STATE â”‚     â”‚   â”‚                           â”‚
         â”‚ âš ï¸ Weak Signal â”‚     â”‚   â”‚                           â”‚
         â”‚                â”‚     â”‚   â–¼                           â”‚
         â”‚ â€¢ Countdown:   â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
         â”‚   1-4 seconds  â”‚     â”‚  â”‚   RED STATE          â”‚    â”‚
         â”‚ â€¢ Color:       â”‚     â”‚  â”‚  ğŸ”´ EMERGENCY        â”‚    â”‚
         â”‚   ORANGE ğŸŸ     â”‚     â”‚  â”‚                      â”‚    â”‚
         â”‚ â€¢ Controls:    â”‚     â”‚  â”‚ â€¢ Countdown: 0.0s    â”‚    â”‚
         â”‚   ENABLED      â”‚     â”‚  â”‚ â€¢ Color: RED         â”‚    â”‚
         â”‚ â€¢ Warn message â”‚     â”‚  â”‚ â€¢ Controls: DISABLED â”‚    â”‚
         â”‚                â”‚     â”‚  â”‚ â€¢ Banner: ACTIVE     â”‚    â”‚
         â”‚ Transition:    â”‚     â”‚  â”‚                      â”‚    â”‚
         â”‚ â€¢ Beat < 4s    â”‚     â”‚  â”‚ Transition:          â”‚    â”‚
         â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤â”€â–ºâ”‚ â€¢ Heartbeat resumes  â”‚    â”‚
         â”‚   back to GREENâ”‚     â”‚  â”‚   (can restart)      â”‚    â”‚
         â”‚ â€¢ Beat 4-5s    â”‚     â”‚  â”‚ â€¢ User clicks        â”‚    â”‚
         â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¤â”€â–ºâ”‚   Emergency Restart  â”‚    â”‚
         â”‚   stay ORANGE  â”‚     â”‚  â”‚   (clears flag)      â”‚    â”‚
         â”‚ â€¢ Beat > 5s    â”‚     â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚    â”‚
         â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”˜ Back to GREEN        â”‚    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                         â”‚    â”‚
                                â”‚   Controls RE-ENABLED   â”‚    â”‚
                                â”‚   Restart button hides  â”‚    â”‚
                                â”‚   Banner disappears     â”‚    â”‚
                                â”‚   System READY          â”‚    â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## â±ï¸ TIMING CRITICAL THRESHOLDS

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              HEARTBEAT AGE EVALUATION LOGIC                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

              â”‚
              â”‚  0ms         1000ms      2000ms      3000ms
              â”‚              â”‚           â”‚           â”‚
              â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€ GREEN ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Heartbeat < 4000ms old           â”‚
    â”‚ Time to emergency: >1 second     â”‚
    â”‚ Status: âœ“ Connected              â”‚
    â”‚ UI: Green countdown              â”‚
    â”‚ Controls: ENABLED                â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

                    4000ms       4500ms       5000ms
                      â”‚           â”‚           â”‚
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”´â”€ ORANGE ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Heartbeat 4000-5000ms old            â”‚
    â”‚ Time to emergency: 0-1 second        â”‚
    â”‚ Status: âš ï¸ Weak Signal               â”‚
    â”‚ UI: Orange countdown (pulsing)       â”‚
    â”‚ Controls: ENABLED (but user warned)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€


                                5000ms       5500ms    6000ms
                                  â”‚           â”‚        â”‚
                      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€ RED ZONE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    â”‚ Heartbeat > 5000ms old                        â”‚
    â”‚ Time to emergency: TRIGGERED                   â”‚
    â”‚ Status: ğŸ”´ CONNECTION LOST                     â”‚
    â”‚ Action: AUTO EMERGENCY STOP                    â”‚
    â”‚ UI: Red countdown (0.0s)                       â”‚
    â”‚ Controls: DISABLED                             â”‚
    â”‚ Banner: Red emergency message                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    CHECKING INTERVAL                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Main monitoring loop runs EVERY 200 milliseconds (5 times per second)

This means:
 â€¢ Maximum detection delay: 200ms
 â€¢ Detection is essentially real-time
 â€¢ Countdown display updates 5 times per second
 â€¢ Smooth animation, no visible lag


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ESP32 WRITE INTERVAL                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ESP32 writes heartbeat EVERY 2500 milliseconds (2.5 seconds)

This means:
 â€¢ Watchdog has 5 seconds before triggering = 2x safety margin
 â€¢ If ESP32 network is stable: Write 2.5s, Check finds 0s old
 â€¢ If ESP32 WiFi hiccups (3s): Watchdog shows 4s old (warning!)
 â€¢ If ESP32 totally disconnects (10s): Watchdog triggers at 5s
```

---

## ğŸ¯ DECISION FLOWCHART

```
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Web loads page  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Initialize watchdog    â”‚
                    â”‚  Start listening to     â”‚
                    â”‚  /robot/lastHeartbeat   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Start 200ms polling    â”‚
                    â”‚  loop (every 200ms)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ Get current timestamp   â”‚
         â”‚          â”‚ Get last heartbeat      â”‚
         â”‚          â”‚ Calculate difference    â”‚
         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚ Difference > 5000 ms?   â”‚
         â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚             â”‚
         â”‚          NO   â”‚             â”‚ YES
         â”‚          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”
         â”‚          â”‚           â”‚         â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ > 4000 ms?â”‚     â”‚    â”‚ TRIGGER       â”‚
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚    â”‚ EMERGENCY!    â”‚
         â”‚         â”‚            â”‚    â”‚ â”œâ”€Send true   â”‚
         â”‚   NO  â”Œâ”€â”´â”€â”€YES    ORANGE â”‚ â”‚  to active   â”‚
         â”‚   â”‚   â”‚                  â”‚ â”‚ â”œâ”€Red banner â”‚
         â”‚   â”‚   â”‚                  â”‚ â”‚ â”œâ”€Red color  â”‚
         â”‚   â”‚   â”‚                  â”‚ â”‚ â”œâ”€Disabled   â”‚
         â”‚   â”‚   â”‚                  â”‚ â”‚ â””â”€Show restartâ”‚
         â”‚   â”‚   â”‚                  â”‚ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚   â”‚   â”‚                  â”‚      â”‚
         â”‚ GREEN â”‚              â”Œâ”€â”€â”€â”´â”€â”€â”   â”‚
         â”‚ ğŸŸ¢    â”‚              â”‚      â”‚   â”‚ Wait for
         â”‚ 5.0s  â”‚              â–¼      â”‚   â”‚ heartbeat
         â”‚ âœ“OK   â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”   â”‚   â”‚ and
         â”‚ Enabled         â”‚    â”‚   â”‚   â”‚   â”‚ user click
         â”‚   â”‚             â”‚    â”‚   â”‚   â”‚   â”‚
         â”‚   â””â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”˜    â”‚   â”‚   â”‚   â”‚
         â”‚         â”‚   â”‚        â”‚   â”‚   â”‚   â”‚
         â”‚         â””â”€â”€â”€â”¤        â”‚   â”‚   â”‚   â”‚
         â”‚             â”‚        â”‚   â”‚   â”‚   â”‚
         â”‚          â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
         â”‚          â”‚                  â”‚   â”‚
         â”‚     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”´â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     â”‚ Update UI:  â”‚       â”‚ Heartbeat     â”‚
         â”‚     â”‚ â”œâ”€Countdown â”‚       â”‚ resumes?      â”‚
         â”‚     â”‚ â”œâ”€Colors    â”‚       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚     â”‚ â”œâ”€Messages  â”‚            â”‚
         â”‚     â”‚ â””â”€Buttons   â”‚       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚ Enable restart  â”‚
         â”‚          â”‚               â”‚ button (show)    â”‚
         â”‚          â”‚               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚                    â”‚
         â”‚          â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚            â”‚ User clicks      â”‚
         â”‚          â”‚            â”‚ "Restart"?       â”‚
         â”‚          â”‚            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚                 â”‚
         â”‚          â””â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚               â”‚      â”‚ WRITE false â”‚
         â”‚               â”‚      â”‚ to active   â”‚
         â”‚               â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
         â”‚               â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                         â”‚              â”‚
                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Controls re-    â”‚
                  â”‚ enabled (500ms) â”‚
                  â”‚ Reset UI        â”‚
                  â”‚ Ready!          â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â–º (Loop continues)
                                  Checks every 200ms
```

---

## ğŸ§ª TEST SCENARIO TIMELINES

### Scenario A: Perfect Connection
```
T=0s:     ESP32 sends beat â”€â”€â–º DB: 1704067240000
T=0.1s:   Web reads it          Compare: 0.1s old â†’ GREEN âœ“
T=0.2s:   Web checks again      Compare: 0.2s old â†’ GREEN âœ“
...continues every 200ms with tiny delta...
T=2.5s:   ESP32 sends NEW beat â”€â”€â–º DB: 1704067242500
T=2.6s:   Web reads it          Compare: 0.1s old â†’ GREEN âœ“
...repeats...

RESULT: GREEN always. No emergency. All controls enabled.
```

### Scenario B: WiFi Dropout (5 seconds)
```
T=0s:     ESP32 sends beat â”€â”€â–º DB: 1704067240000
T=2.5s:   ESP32 TRIES to send but WiFi is DOWN âœ—
T=4s:     Web reads                Compare: 4.0s old â†’ ORANGE âš ï¸
          Show warning message
          Countdown pulsing
T=4.2s:   Web reads                Compare: 4.2s old â†’ ORANGE
T=4.5s:   Web reads                Compare: 4.5s old â†’ ORANGE
T=5.05s:  Web reads                Compare: 5.05s old â†’ RED ğŸ”´
          WRITE emergency/active = true
          Show emergency banner
          Disable all buttons
          Show restart button (disabled, no beat)
T=5.2s:   Web reads                Compare: 5.2s old â†’ RED
T=8s:     WiFi reconnects
          ESP32 resends â”€â”€â–º DB: 1704067248000
T=8.1s:   Web reads          Compare: 0.1s old â†’ GREEN âœ“
          Heartbeat restored success!
          Enable restart button (NOW CLICKABLE)
T=8.2s:   USER CLICKS "Emergency Restart"
          WRITE emergency/active = false
          Re-enable all controls
          Hide banner
          Hide restart button

RESULT: Emergency stop triggered at T=5.05s. User restarts at T=8.2s.
Robot paused for ~3 seconds during WiFi outage.
```

### Scenario C: Intermittent WiFi (Weak)
```
T=0s:     ESP32 sends beat â”€â”€â–º DB: 1704067240000
T=2.5s:   ESP32 TRY send... wifi WEAK but succeeds (delayed)
          Actually sends at T=3.5s â”€â”€â–º DB: 1704067243500
T=3.6s:   Web reads           Compare: 0.1s old â†’ GREEN
T=4.0s:   Web reads           Compare:... WAIT, no new beat
          Last beat still T=2.5s result
          Compare: 4.0s old â†’ ORANGE âš ï¸
T=4.5s:   Web reads                Compare: 4.5s old â†’ ORANGE
T=5.2s:   Web reads                Compare: 5.2s old â†’ RED ğŸ”´
          TRIGGER EMERGENCY
T=6.0s:   ESP32 finally connects and sends beat
          â”€â”€â–º DB: 1704067246000
T=6.1s:   Web reads           Compare: 0.1s old â†’ GREEN âœ“
          Enable restart button
T=6.3s:   USER CLICKS "Restart"
          System resumes

RESULT: User sees orange warning for ~1 second (T=4.0-T=5.2s),
emergency triggers briefly, restarts quickly after connection.
Total pause: ~1-2 seconds depending on when heartbeat arrives.
```

---

This comprehensive system ensures fail-safe behavior: **loss of connection = automatic stop, never an accidental resume**.
